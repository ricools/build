name: Build Armbian AML S9XX Box with KVM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git gcc g++ make libc6-dev libncurses-dev \
          qemu-user-static binfmt-support python3 python3-pip \
          rsync bc uuid-runtime flex bison libssl-dev libelf-dev \
          device-tree-compiler wget

    - name: Clone Armbian Build Framework
      run: |
        git clone --depth 1 https://github.com/armbian/build.git

    - name: Prepare userpatches (Enable KVM)
      run: |
        mkdir -p build/userpatches/kernel/meson64-edge
        mkdir -p build/userpatches/dtb/meson64

        cat << 'EOF' > build/userpatches/kernel/meson64-edge/kvm-enable.config
CONFIG_KVM=y
CONFIG_KVM_ARM_HOST=y
CONFIG_VHOST=y
CONFIG_VHOST_NET=y
CONFIG_VHOST_VSOCK=y
CONFIG_ARM64_VA_BITS_48=y
EOF

        cat << 'EOF' > build/userpatches/dtb/meson64/enable-hyp.patch
/dts-v1/;

/ {
    hypervisor {
        compatible = "linux,kvm";
        status = "okay";
    };
};
EOF

    - name: Build AML S9XX Box Image with KVM Enabled
      run: |
        cd build
        ./compile.sh image \
          --board aml-s9xx-box \
          --branch edge \
          --release bookworm \
          --no-desktop \
          --kernel-config custom \
          --variant minimal

    - name: Upload Image Artifact
      uses: actions/upload-artifact@v4
      with:
        name: armbian-aml-s9xx-box-kvm
        path: build/output/images/*.img
