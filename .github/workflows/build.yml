name: Build Armbian aml-s9xx-box with KVM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Armbian build repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git curl wget qemu-user-static binfmt-support \
            build-essential gcc g++ make python3 python3-pip bison flex libssl-dev \
            bc kmod rsync tar gzip xz-utils debootstrap parted

      ###############################################################
      # ‚ú® Tambahkan patch otomatis untuk enable KVM di Kernel
      ###############################################################
      - name: Apply Kernel KVM Patch
        run: |
          mkdir -p userpatches/kernel/meson64-current
          cat << 'EOF' > userpatches/kernel/meson64-current/9999-enable-kvm.patch
          diff --git a/arch/arm64/configs/defconfig b/arch/arm64/configs/defconfig
          index 1234567..abcdef0 100644
          --- a/arch/arm64/configs/defconfig
          +++ b/arch/arm64/configs/defconfig
          @@ -1,5 +1,20 @@
           # Enable virtualization extensions
          +CONFIG_KVM=y
          +CONFIG_KVM_ARM_HOST=y
          +CONFIG_KVM_ARM_V8=y
          +CONFIG_VHOST=y
          +CONFIG_VHOST_NET=y
          +CONFIG_VHOST_VSOCK=y
          +CONFIG_VHOST_CROSS_ENDIAN_LEGACY=y
          +CONFIG_IRQ_BYPASS_MANAGER=y
          +CONFIG_TUN=y
          +CONFIG_BRIDGE=y
          +CONFIG_NETFILTER=y
          +CONFIG_NETFILTER_XTABLES=y
          +CONFIG_NETFILTER_NETLINK=y
          +CONFIG_NET_CORE=y
          +CONFIG_NET=y

          EOF

      ###############################################################
      # üöÄ Jalankan Build Armbian
      ###############################################################
      - name: Build Armbian Image
        run: |
          ./compile.sh \
            BOARD=aml-s9xx-box \
            BRANCH=current \
            RELEASE=jammy \
            BUILD_MINIMAL=no \
            BUILD_DESKTOP=no \
            KERNEL_ONLY=no \
            KERNEL_CONFIGURE=no \
            COMPRESS_OUTPUTIMAGE=sha,gpg,xz

      ###############################################################
      # üì¶ Upload ke Artifact
      ###############################################################
      - name: Upload image artifacts
        uses: actions/upload-artifact@v3
        with:
          name: aml-s9xx-box-kvm
          path: output/images/*

      ###############################################################
      # üè∑ Auto Release
      ###############################################################
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: ${{ github.event_name == 'workflow_dispatch' }}
        with:
          tag_name: aml-s9xx-kvm-${{ github.run_id }}
          files: output/images/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
