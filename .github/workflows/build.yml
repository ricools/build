name: Build Armbian AML S9XX Box with KVM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y \
          git gcc g++ make libc6-dev libncurses-dev \
          qemu-user-static binfmt-support python3 python3-pip \
          rsync bc uuid-runtime flex bison libssl-dev libelf-dev \
          device-tree-compiler wget

    - name: Clone Armbian Build Framework
      run: |
        set -e
        # Clone the Armbian build system repository
        git clone --depth 1 https://github.com/armbian/build.git

    - name: Prepare userpatches (Enable KVM in Kernel)
      run: |
        set -e
        # The target kernel family for the aml-s9xx-box (edge branch) is meson64.
        # We place the custom config fragment here.
        KVM_PATCH_DIR="build/userpatches/kernel/meson64-edge"
        mkdir -p "${KVM_PATCH_DIR}"

        # This config fragment enables KVM host support for ARM64 and required features.
        cat > "${KVM_PATCH_DIR}/kvm-enable.config" <<EOF
CONFIG_KVM=y
CONFIG_KVM_ARM_HOST=y
CONFIG_VHOST=y
CONFIG_VHOST_NET=y
CONFIG_VHOST_VSOCK=y
CONFIG_ARM64_VA_BITS_48=y
EOF
        # NOTE: Removed the DTB patch because simple DTS fragments are prone to 
        # compilation failure in the Armbian build system. Kernel config should be sufficient.

    - name: Build AML S9XX Box Image with KVM Enabled
      run: |
        set -e
        cd build
        # Use --kernel-config custom to ensure our kvm-enable.config is merged
        ./compile.sh image \
          --board aml-s9xx-box \
          --branch edge \
          --release bookworm \
          --no-desktop \
          --kernel-config custom \
          --variant minimal

    - name: Upload Image Artifact
      uses: actions/upload-artifact@v4
      with:
        name: armbian-aml-s9xx-box-kvm
        # The path must be relative to the workspace root, even though we built in 'build'
        path: build/output/images/*.img
